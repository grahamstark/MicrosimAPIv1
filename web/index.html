<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>A Budget for Scotland/Microsim API V1 Demo</title>
    <link rel="icon" href="images/favicon.ico?v=2.0.0" type="image/x-icon">
    <link rel="stylesheet" href="css/stb-bootstrap.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <script type='text/javascript' src='js/jquery.js'></script>
    <script type='text/javascript' src='js/jquery.periodicalupdater.js'></script>
    <script type='text/javascript' src='js/jquery.validate.js'></script>
    <script type='text/javascript' src='js/jquery.number.js'></script>
    <script type='text/javascript' src='js/formatting-libs.js'></script>
    <!-- bootstrap -->
    <script src="js/bootstrap.bundle.js"></script>
    <!-- vega graphics -->
    <script type="text/javascript" src="js/vega-lite.min.js"></script>
    <script type="text/javascript" src="js/vega.js"></script>
    <script type="text/javascript" src="js/vega-embed.min.js"></script>
    <!-- templates -->
    <script type='text/javascript' src="js/mustache.min.js"></script>
   
</head>

<body class='text-primary p-2'>
     <nav class="navbar navbar-expand-lg text-primary">
            <ul class="nav">
                <li class="nav-item"><a class='nav-link' href='https://stb.virtual-worlds.scot/scotbudg/'>A Scottish Budget</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href='https://ubi.virtual-worlds.scot/'>Basic Income</a></li>
                <li class="nav-item"><a class='nav-link' href='https://stb.virtual-worlds.scot/bcd/'>Budget Constraints</a></li>
                <li class="nav-item"><a class='nav-link' href='https://stb-blog.virtual-worlds.scot/'>Blog</a></li>
            </ul>
        </nav>
 <header>
    <h1>A Budget for Scotland</h1>
    <h2>2025/6 Version</h2>
    <p>Using:<p>
    <ul>
        <li><a href='https://github.com/grahamstark/ScottishTaxBenefitModel.jl'>ScotBen</a></li>
        <li><a href='https://github.com/grahamstark/MicrosimAPIv1'>MicrosimAPI, V1</a></li>
    </ul>
</header>        


        <form id='mainform' action="thing" method="POST">       

            <input type="hidden" id="session_id" name="session_id" />

            <div class='container-fluid'>                 
                <div class='row'><!-- input row -->
                    <fieldset class="col border rounded-2 m-1 p-2">
                        <legend>Income Tax</legend>
                                <input type="hidden" id="tax-n" name="tax-n" value=""/>
                                <table id='it-table' class="table table-sm table-striped">
                                    <caption>Rates in %, bands in &pound;s pa</caption>
                                    <thead>                                                    
                                        <tr>
                                            <th>Rate (%)</th>
                                            <th>Band (£pa)</th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id='tax-rows'>
                                    </tbody>
                                </table>
                                <div class="col ukreserved p-2 rounded-2">
                                    <label for='taxallowance' class='form-label'>Personal Allowance £pa</label>
                                    <input id='taxallowance' type='number' name="taxallowance" min='0' max='100000' value='' step='1' size="12" class='form-control w-50'/>
                                </div>                                
                    </fieldset>
                    <fieldset class='col border rounded-2 m-1 p-2 ukreserved'>
                        <legend>National Insurance</legend>
                        <input type="hidden" id="ni-n" name="ni-n" value=""/>
                        <table class="table table-sm table-striped">
                            <caption>Rates in %, bands in &pound;s pw</caption>
                            <thead>
                                <tr>
                                    <th>Rate (%)</th>
                                    <th>Band (£pw)</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id='ni-rows'>
                            </tbody>
                        </table>
                    </fieldset>
                    <fieldset class='col border  rounded-2 m-1 p-2'>
                        <legend>Scottish Benefits</legend>
                        <div class="row">                                        
                            <div class="col">                                                    
                                <label for='scottish_child_payment' class='form-label'>Scottish Child Payment £pw</label>
                                <input id='scottish_child_payment' type='number' name="scottish_child_payment" min='0' max='400' value='' step='0.01' size="10" class='form-control w-50'/>
                            </div>
                        </div>
                        <div class="row">                                        
                            <div class="col">                                                    
                                <label for='scp_age' class='form-label'>Scottish Child Payment: maximum age (years)</label>
                                <input id='scp_age' type='number' name="scp_age" min='0' max='18' value='' step='1' size="4" class='form-control w-50'/>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class='col border rounded-2 m-1 p-2 ukreserved'>
                            <legend>UK (Reserved) Benefits</legend>                                            
                            <div class="row">                                        
                                <div class="col">                                                    
                                    <label for='uc_single' class='form-label'>Universal Credit: Single over 25 (£pm)</label>
                                    <input id='uc_single' type='number' name="uc_single" min='0' max='2000' value='' step='0.01' size="10" class='form-control w-50'/>
                                </div>
                            </div>
                            <div class="row">                                                                                    
                                <div class="col">                                                    
                                    <label for='uc_taper' class='form-label'>Universal Credit Taper (%)</label>
                                    <input id='uc_taper' type='number' name="uc_taper" min='1' max='100' value='' step='1' size="10" class='form-control w-50'/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">                                                    
                                    <label for='child_benefit' class='form-label'>Child Benefit (1st child) £pw</label>
                                    <input id='child_benefit' type='number' name="child_benefit" min='0' max='1000' value='' step='0.01' size="10" class='form-control w-50'/>
                                </div>
                            </div>
                            <div class="row">
                                    <div class="col">                                                    
                                        <label for='pension' class='form-label'>New State Pension £pw</label>
                                        <input id='pension' type='number' name="pension" min='0' max='1000' value='' step='0.01' size="10" class='form-control w-50'/>
                                    </div>                                                
                            </div>
                    </fieldset>
                </div> <!-- input row -->
                <div class="row"> <!-- progress bar -->
                    <div class="col"></div>
                    <div class='col-4' id="progress-indicator"></div>
                    <div class="col"></div>
                </div> <!-- output row -->
                
                <fieldset class="row">
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col">
                        <ul class="nav">
                            <li class="nav-item  p-2">                      
                                <button  type="button" class='btn btn-warning rounded-2' value='' onclick='params_get("initialise")'>Reset</button>
                            </li>
                            <li class="nav-item p-2">                      
                                <button  type="button" class='btn btn-info rounded-2' value='' onclick='params_set()'>Save</button>
                            </li>
                            <li class="nav-item p-2">                      
                                <button  type="button" class='btn btn-success rounded-2' value='' onclick='run_submit()'>Run</button>
                            </li>
                        </ul>
                    </div>
                </fieldset> <!-- submission row -->
                <div class="row  border rounded-2 m-1 p-2">
                    <div class='col'>
                            <div id='output-fields'>
                                <div class='row'>
        
                                    <div class='col-4'></div>
                                    <div class='col-4'>
                                        <h2>Results for some Example Families</h2>
                                    </div>
                                    <div class='col-4'></div>
                                </div>
                                <div class='row'>
                                    <div class='col-12' id='examples'>
                                       
                                    </div>
                                </div>
                                <div class='row'>
                                    <div class='col-4'></div>
                                    <div class='col-4'>
                                        <h2>Results for the Whole of Scotland</h2>
                                    </div>
                                    <div class='col-4'></div>
                                </div>
                                <div class='row'>
                                    <div class='col'>
                                        <h4>Gainers and Losers</h4>
                                        <div class='row'>
                                            <div class='col' id="gain-lose-ten-gl">,</div>
                                            <div class='col' id="gain-lose-dec-gl">,</div>
                                            <div class='col' id="gain-lose-hhtype-gl">,</div>
                                            <div class='col' id="gain-lose-children-gl">,</div>
                                            <div class='col' id="deciles-graph">,</div>
                                        </div>
                                    </div>
                                    <div class='col'>
                                        <h4>Revenues and Costs</h4>
                                        <div
                                            data-bs-toggle='modal' 
                                            data-bs-target='#short_income_summary'>
                                            <div id="short_income_summary"></div>
                                        </div>
                                        <div id="very_short_income_summary"></div>
                                    </div>                            
                                    <div class='col'>
                                        <h4>Incentives - Marginal Effective Tax Rates</h4>
                                        <div id="metrs"></div>
                                    </div>                            
                                </div><!-- row -->
                                <div class='row'>
                                    <div class='col'>
                                        <h4>Poverty</h4>
                                        <div id='povtrans_matrix'></div>
                                    </div>
                                    <div class='col'>
                                        <h4>Inequality</h4>
                                        <div id='inequality'></div>
                                    </div>
                                    <div class='col'>
                                        <div id='lorenz'></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
         
               </div> <!-- output row -->
               <div class="row">
                   
                    <div class='col' id='endnotes'></div>
                    
                </div>
            </div> <!-- main container -->
        </form>
<footer class='footer'>
    <p>
        This is a demo of running a microsimulation model using a Julia implementation of our proposed API.
    </p>
    <p><a href='https://microapi.virtual-worlds.scot/docs/'>API Spec In Swagger Format</a></p>
    <p><a href='docs/microsimapi-v1.pdf'>Draft Documentation</a></p>
</footer>

</body>

<script type='text/javascript'>

const BIG_A = 9999999999;

function makeTypename( type ){
    return type=='rate' ? 'r' : 'b';
}

function makeId( n, name, type ){
    var typename = makeTypename( type );
    return name + "-" + typename + '-' + n;
}

function makeInput( n, name, type ){
    var typename = makeTypename( type );
    var min=-BIG_A;
    var max=BIG_A;
    var step=1;
    if( type == 'band' ){
        min=0.0;
        max=BIG_A;
    } else if( type=='rate'){
        min=0.0;
        max=100;
        step=0.01;
    }
    var id = makeId( n, name, type );
    return "<input id='"+id+"' name='"+id+"' type='number' min='"+min+"' max='"+max+"' step='"+step+"' value='' class=' w-75' />";
}

/**
 * action: like 'del-tax'
 * n : array index (from 1, not 0)
 **/
function editTable( action, n ){
    console.log( "action=", action, "n=", n );
    var tt = action.split("-");
    which = tt[1];
    rbs = scrapetax( which );
    rates = rbs[0];
    bands = rbs[1];

    pos = n-1
    if(tt[0] == 'del'){
        rbs[0].splice(pos,1);
        rbs[1].splice(pos,1);
    } else if(tt[0] == 'add'){
        rbs[0].splice(pos, 0, 0.0);
        rbs[1].splice(pos, 0, 0.0 );
    } else {
        console.log( "unknown action=", tt[0] );
    }
    console.log( "rbs=", rbs, "n=", n );
    initialiseTable( which, rbs[0], rbs[1], rbs[0], rbs[1] );
}

function makeAddDel( n, name, isdel ){
    var action = 'add-'+name;
    var icon = "bi-plus-circle text-success";
    if(isdel===true){
        action = 'del-'+name;
        icon = "bi-dash-circle text-danger";
    }
    return "<span onclick='editTable(\""+action+"\", "+n+")' ><i class=\""+icon+"\" style=\"font-size: 1rem\"></i></span>";
}

function makeRow( n, name, addDel ){
    const id = name+"-"+n;
    var row = "<tr id='"+id+"'><td>"+makeInput( n, name, 'rate' )+"</td><td>"+makeInput( n, name, 'band' )+"</td><td  class='align-middle'>"+makeAddDel( n, name, false )+"</td>";
    if( addDel ){
        row += "<td class='align-middle'>"+makeAddDel( n, name, true )+"</td>";
    } else {
        row += "<td></td>";
    }
    row += "</tr>";
    // console.log( "made row as |"+row+"|" );
    return row;
}

function insertRow( which, n, name, addRow ){
    $("#"+which ).append( makeRow( n, name, addRow ));
}

function setVal( id, val, def ){
    $( "#"+id ).val( val );
    console.log( "setVal for #%s val=%s def=%s", id, val, def )
    if( val != def ){
        $( "#"+id ).addClass( 'changed');
    } else {
        $( "#"+id ).removeClass( 'changed');
    }
}

function loadTax( name, rates, bands, defrates, defbands ){
    var nr = rates.length;
    var nb = bands.length;
    // console.log( "nr="+nr + " nb = " + nb );
    $( "#"+name+"-n").val( nr );
    for( var i = 1; i <= nr; i++ ){
        var rp = "#"+name+"-r-"+i;
        $( rp ).val( rates[i-1]);
        var rb = "#"+name+"-b-"+i;
        if( i == nr ){
            $( rb ).hide();            
        } else {
            $( rb ).val( bands[i-1]);
        }
    }
}

function initialiseTable( which, rates, bands, defrates, defbands ){
    var n = rates.length;
    var target = which+ "-rows";
    $( "#"+target ).children().remove();
    var addDel = n > 1;
    for( var i = 1; i <= n; i++ ){
        insertRow( target, i, which, addDel );
    }
    loadTax( which, rates, bands, defrates, defbands );
}

function loadData( data ){
    loadtax( "tax", data.taxrates, data.taxbands );
    loadtax( "ni", data.nirates, data.nibands );
    $( "#taxallowance").val( data.taxallowance );
}

function scrapetax( name ){
    var rates = [];
    var bands = [];
    var nrt = "#"+name+"-n";
    // console.log( "count nrt key = " + nrt );
    var nr = parseInt($( nrt ).val());
    // console.log( name + " : got nr as " + nr );
    for( var i = 1; i <= nr; i++ ){
        var rp = "#"+name+"-r-"+i;
        var rb = "#"+name+"-b-"+i;
        rates.push( parseFloat($( rp ).val()));
         if( i < nr ){ // skip top bands
            var rr = parseFloat($( rb ).val());
            if( Number.isNaN(rr)){
                rr = BIG_A;
            }
            bands.push( rr );
        }
    }
    // console.log( "rates=" + rates );
    return [rates, bands];
}

function scrapeData(){
    var tbs = scrapetax("tax");
    // console.log( "tbs=" + tbs );
    var nbs = scrapetax( "ni");
    var data = {
        taxrates: tbs[0],
        taxbands: tbs[1],
        nirates: nbs[0],
        nibands: nbs[1],
        taxallowance: parseFloat($( "#taxallowance" ).val()),
        child_benefit: parseFloat( $( "#child_benefit" ).val()),
        pension: parseFloat( $( "#pension" ).val()),
        scottish_child_payment: parseFloat( $( "#scottish_child_payment" ).val()),
        scp_age: parseInt( $( "#scp_age" ).val()),
        uc_single: parseFloat( $( "#uc_single" ).val()),
        uc_taper: parseFloat( $( "#uc_taper" ).val())
    }
    // console.log( "data.taxrates " + data.taxrates );
    return data;
}


function populateForm( session_id, pars, defaults ){
    initialiseTable( "tax", 
        pars.taxrates, 
        pars.taxbands,
        defaults.taxrates,
        defaults.taxbands );
    initialiseTable( "ni", 
        pars.nirates, 
        pars.nibands,
        defaults.nirates, 
        defaults.nibands
            );
    console.log( "setting the session_id to ", session_id );
    setSessionId( session_id );
    setVal( 'taxallowance', pars.taxallowance, defaults.taxallowance);
    setVal( 'child_benefit', pars.child_benefit, defaults.child_benefit );
    setVal( 'pension', pars.pension, defaults.pension );
    setVal( 'scottish_child_payment', pars.scottish_child_payment, defaults.scottish_child_payment );
    setVal( 'scp_age', pars.scp_age, defaults.scp_age );
    setVal( 'uc_single', pars.uc_single, defaults.uc_single );
    setVal( 'uc_taper', pars.uc_taper, defaults.uc_taper );
}

var updater;

function drawRunProgress( result ){
    // https://getbootstrap.com/docs/5.0/components/progress/
    console.log( "result.count" + result.count + "result.size" + result.size );
    var pct = Math.trunc(100 * result.count / result.size);
    var prog = 
        "<p>Model Running</p>"+
        "<div class='progress'>"+
        "<div class='progress-bar bg-success progress-bar-animated progress-bar-striped' role='progressbar' "+
            "aria-valuenow='" + pct + "' " + 
            "style='width: "+pct+"%' " +
            "aria-valuemin='0' " +
            "aria-valuemax='100'>"+
            pct + "%" +
            "</div> "+
            "</div>";
    console.log( "prog="+prog )
    $("#progress-indicator").html( prog );
}



function createLorenzCurve( targetId, result, thumbnail ){
    var height = 300;
    var xtitle = "Population Share";
    var ytitle = "Income Share";
    var title = "Lorenz Curve"
    if( thumbnail ){
        var height = 70;
        xtitle = "";
        ytitle = "";
        title = "";
    }
    var width = Math.trunc( GOLDEN_RATIO*height);
    var data=[];
    console.log( "deciles" + result.lorenz_pre.toString());
    console.log( "lorenz_pre length" + result.lorenz_pre.length );
    // deciles levels are rhs. so push a 0,0
    data.push( {"popn1":0, "pre":0 });
    popn = 0.0;
    incr = 1/result.lorenz_pre.length;
    for( var i = 0; i < result.lorenz_pre.length; i++){
        popn += incr;
        data.push( {"popn1":popn, "pre":result.lorenz_pre[i] });
    }
    // var data_post= [];
    data.push( {"popn2":0, "post":0 });
    popn = 0.0;
    for( var i = 0; i < result.lorenz_post.length; i++){
        popn += incr;
        data.push( {"popn2":popn, "post":result.lorenz_post[i] });
    }
    data.push( {"popn3":0.0, "base":0.0});
    data.push( {"popn3":1.0, "base":1.0});
    var gini_vg = {
        "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
        "title": title,
        "width": width,
        "height": height,
        "description": title,
        "data": {"values": data }, // , "post":data_post
        "layer":[
            {
                "mark": "line",
                "encoding":{
                    "x": { "type": "quantitative",
                           "field": "popn1",
                           "axis":{
                               "title": xtitle
                           }},
                    "y": { "type": "quantitative",
                           "field": "pre",
                           "axis":{
                              "title": ytitle
                           } },
                    "color": {"value":"blue"}
                } // encoding
            }, // pre layer line
            {
                "mark": "line",
                "encoding":{
                    "x": { "type": "quantitative",
                           "field": "popn2",
                           "axis":{
                              "title": xtitle
                           }},
                    "y": { "type": "quantitative",
                           "field": "post",
                           "axis":{
                              "title": ytitle
                           } },
                   "color": {"value":"red"}
               } // encoding
           }, // post line
          { // diagonal in grey
               "mark": "line",
               "encoding":{
                   "x": { "type": "quantitative",
                          "field": "popn3" },
                   "y": { "type": "quantitative",
                          "field": "base" },
                   "color": {"value":"#ccc"},
                   "strokeWidth": {"value": 1.0}
                   // "strokeDash":
               } // encoding
           },
        ]
    }
    vegaEmbed( targetId, gini_vg );
}

const GOLDEN_RATIO = 1.618
 
function createDecileBarChart( targetId, result, thumbnail ){
    var height = 300;
    var xtitle = "Deciles";
    var ytitle = "Gains in £s p.w.";
    var title = "Gains By Decile"
    if( thumbnail ){
        var height = 70;
        xtitle = "";
        ytitle = "";
        title = "";
    }
    var width = Math.trunc( GOLDEN_RATIO*height);
    var data=[];
    console.log( "deciles" + result.gains_by_decile.toString());
    console.log( "lorenz_pre[2] length" + result.gains_by_decile.length );
    for( var i = 0; i < result.gains_by_decile.length; i++){
        var dec = (i+1);
        data.push( {"decile":dec, "gain":result.gains_by_decile[i] });
    }
    var deciles_vg = {
        "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
        "title": title,
        "width": width,
        "height": height,
        "description": title,
        "data": {"values": data }, // , "post":data_post
        "mark": "bar",
        "encoding":{
            "x": { "type": "ordinal",
                   "field": "decile",
                   "axis":{
                      "title": xtitle
                   }
             },
            "y": { "type": "quantitative",
                   "field": "gain",
                   "axis":{
                      "title": ytitle
                   }
            }
        } // encoding
    }
    console.log( "deciles_vg=" + JSON.stringify(deciles_vg) );

    vegaEmbed( targetId, deciles_vg );
}

function createMainOutputs( result ){
    console.log( result.inequality );
    console.log( result.examples );
    console.log( result.overall_costs )
    $("#examples").html( result.examples );
    $("#gain-lose-table").html( result.gain_lose );
    createDecileBarChart( 
        "#deciles-graph", 
        result, 
        false );
    $("#costs-table").html( result.costs );
    $("#overall-costs").html( result.overall_costs )
    $("#mr-table").html( result.mrs );
    $("#pov-table").html( result.poverty );
    $("#ineq-table").html( result.inequality );
    $("#big-costs-table").html( result.big_costs_table );
    $("#endnotes").html( result.endnotes );
    createLorenzCurve( 
        "#lorenz", 
        result,
        false );
}

function makeExampleBlock( target, exampleResults ){
    return make_examples( exampleResults );
}

function get_result( item, subitem, session_id, htmlifier, target ){
    var url = API+"output/fetch/"+item+"/"+subitem +"?session_id="+session_id;
    console.log( "get_result; url=", url);
    var jqXHR = $.ajax({ 
        url: url,
        method: 'get',
        contentType: "application/json"});
    jqXHR.done(  
        function( data ){
            var out = htmlifier( target, data.item );
            $( "#"+target ).html( out );
        });
}

function create_outputs( session_id ){
    /*
    "headline_figures"=>"Headline Summary ",
    "quantiles_df"=>"Quantiles (50 rows serialsed DF) ", 
    "deciles_df" => "Quantiles (10 rows serialsed DF) ",
    "income_summary" => "Income Summary ", 
    "poverty" => "Poverty Measures ", 
    "inequality" => "Inequality Measures ", 
    "metrs" => "Marginal Effective Tax Rates histogram ", 
    "child_poverty" => "Child Poverty Count ",
    "gain_lose/ten_gl" => "Gain Lose by Tenure ",
    "gain_lose/dec_gl" => "Gain Lose by Decile ",
    "gain_lose/children_gl" => "Gain Lose by Number of Children ",
    "gain_lose/hhtype_gl" => "Gain Lose by Household Size ",
    "poverty_lines" => "Computed Poverty Lines ",
    "short_income_summary"=>"Short Income Summary",
    "very_short_income_summary"=>"Income Summary - just a few key items.",
    "income_hists"=>"Histogram of Incomes ",
    "povtrans_matrix_df"=>"Movements in and out of poverty (as a labelled dataframe)",
    "examples"=>"Simple Worked Examples "
    */
    get_result( "examples", null, session_id, makeExampleBlock, "examples");
    get_result( "gain_lose", 'ten_gl', session_id, formatGainLose, "gain-lose-ten-gl");
    get_result( "gain_lose", 'dec_gl', session_id, formatGainLose, "gain-lose-dec-gl");
    get_result( "gain_lose", 'hhtype_gl', session_id, formatGainLose, "gain-lose-hhtype-gl");
    get_result( "gain_lose", 'children_gl', session_id, formatGainLose, "gain-lose-children-gl");
    get_result( "very_short_income_summary", null, session_id, formatGainLose, "very_short_income_summary");
    
    // #gain-lose-table-dec-gl
    // #gain-lose-table-dec-gl
}

function format_df( df ){
    body = `
    <table class='table-sm table-striped'>

    </table>
    `;

    return body;
}

function updateProgress( session_id, results ){
    console.log( "updateSTB results = ", results );
    /*
    "submitted" => "Job Submitted",
    "do-one-run-start" => "Run Started",
    "weights" => "Weights Calculation",
    "disability_eligibility" => "Calibrating Disability Eligibility",
    "starting" => "Main Calculations Starting",
    "run" => "Running Through Households",
    "dumping_frames" => "Dumping Data to Files",
    "do-one-run-end" => "Run Ended",
    "completed" => "Task Completed - Output is Ready"])
    */
    if( results.error == 'ok' ){
        var progress = results.info;
        switch( progress.phase ){
            case 'submitted':
                $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Run is waiting to start.</div>");
                break;
            case 'do-one-run-start':
                $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Run starting: starting pre-run routines.</div>");
                break;
            case 'weights':
                $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Generating sample weights (may take some time..).</div>");
                break;
            case 'disability_eligibility':
                $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Calibrating Disability Benefits.</div>");
                break;
            case 'starting':
                $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Pre-routines completed; run starting.</div>");
                break;
            case 'run':
                drawRunProgress( progress );
                break;
            case 'dumping_frames':
                $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Calculations complete; now generating output.</div>");
                break;
            case 'do-one-run-end':
                $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Calculations Abd Output Generation complete.</div>");
                break;

            case 'completed':
                $("#progress-indicator").html( "<div></div>" );
                updater.stop();
                create_outputs( session_id );
            break;  
            default:
                $("#progress-indicator").html( "<div class='alert alert-danger' role='alert'>Problem: run "+progress.phase+" can't be found.</div>");
                break; 
        }                                     
    } else {
        $("#progress-indicator").html( "<div class='alert alert-danger'>A Run Error Has Occurred: error is " + results.err + " info: " + results.info + "</div>");
        updater.stop();
    }
}

const API = "https://microapi.virtual-worlds.scot/scotben/"
const API_LOCAL = "http://microapi/scotben/"

/**
 * action - one of 'initialise', 'get'
 */
function params_get(action){
    var session_id = getSessionId();
    $.ajax(
        { url: API+"params/"+action,
         method: 'post',
         dataType: 'json',
         credentials: 'include',
         data: JSON.stringify({"session_id":session_id}),
         contentType: "application/json",
        }).done(
            function( result ){
                console.log( "load_parameters; results are ", result );
                populateForm( result.session_id, result.params, result.default );
            }
        ).fail(
            function( jqXHR, textStatus, errorThrown ){
                console.log( "failed with " + textStatus + " errorThrown "+errorThrown );
                console.log( "jqXHR.statusCode" + jqXHR.status + " text" + jqXHR.statusText );
            }
    );
}

function getSessionId(){
    var session_id = localStorage.getItem( "session_id");
    if(session_id == null){
        session_id = $( "#session_id" ).val();
        if(session_id !== null){
            localStorage.setItem( "session_id", session_id );
        }
    }
    console.log( "getSessionId; got id as ", session_id );
    return session_id;
}

function setSessionId( session_id ){
    // localStorage.setItem( "session_id", session_id );
    $( "#session_id" ).val( session_id );
    localStorage.setItem("session_id", session_id );
}

function params_set(){
    // num_validation_errors = params_validate()
    num_validation_errors = 0
    var session_id = getSessionId();
    console.log( "params_set; valid=", num_validation_errors )
    var params = scrapeData();    
    var dataset = JSON.stringify({'params':params,'session_id':session_id});    
    console.log( "params_set; dataset=", dataset )
    if( num_validation_errors == 0){
        $.ajax(
            { url: API+"params/set",
            method: 'post',
            dataType: 'json',
            data: dataset,
            contentType: "application/json",
            }).done(
                function( result ){                    
                    console.log( "load_parameters; results are ", result );
                    populateForm( result.session_id, result.params, result.default );                    
                }
            ).fail(
                function( jqXHR, textStatus, errorThrown ){
                    console.log( "failed with " + textStatus + " errorThrown "+errorThrown );
                    console.log( "jqXHR.statusCode" + jqXHR.status + " text" + jqXHR.statusText );
                }
        );
    } else {
        // place errers by inputs
    }
}

function params_validate(){
    var params = scrapeData();
    var session_id = getSessionId(); // ( "#session_id" ).val();
    // var dataset = JSON.stringify({'params':params,'session_id':session_id});    
    var dataset = JSON.stringify({'params':params,'session_id':session_id});    
    var num_validation_errors = 0;
    console.log( "params_validate dataset=",dataset)
    var jqXHR = $.ajax(
        { url: API+"params/validate",
         method: 'post',
         dataType: 'json',
         contentType: "application/json",
         data: dataset
        });
    jqXHR.done( function( data ) {
        console.log( "second complete", data );
        num_validation_errors = Object.keys(data).length;
        console.log( "data length", num_validation_errors );
        if(num_validation_errors > 0){
            // add error messages
        }
    });
    console.log( "params_validate; returning valid=", num_validation_errors )
    return num_validation_errors;
}

function startMonitor( data, textStatus, jqXHR ){
    console.log( "starting run and timer");               
    console.log( "startMonitor; data.session_id=" + data.session_id );
    var session_id = getSessionId();
    var uri = API+'run/status?session_id='+session_id;
    console.log( "startMonitor; got session id ", session_id);
    var dataset = JSON.stringify({'session_id':session_id});
    updater = $.PeriodicalUpdater(API+'run/status', {
        url: uri,         // URL of ajax request
        cache: false,     // By default, don't allow caching
        method: 'GET',    // method; get or post
        data: dataset,    // array of values to be passed to the page - e.g. {name: "John", greeting: "hello"}
        minTimeout: 500,  // starting value for the timeout in milliseconds was: 1000
        maxTimeout:32000, // maximum length of time between requests was: 64000
        multiplier: 1,    // if set to 2, timerInterval will double each time the response hasn't changed (up to maxTimeout)
        maxCalls: 0,      // maximum number of calls. 0 = no limit.
        maxCallsCallback: null, // The callback to execute when we reach our max number of calls
        autoStop: 0,      // automatically stop requests after this many returns of the same data. 0 = disabled
        autoStopCallback: null, // The callback to execute when we autoStop
        cookie: false,    // whether (and how) to store a cookie
        runatonce: false, // Whether to fire initially or wait
        verbose: 0        // The level to be logging at: 0 = none; 1 = some; 2 = all
    }, function( remoteData, success, xhr, handle ) {
        console.log( "progress: got %o", remoteData );
        updateProgress( session_id, remoteData );
    });
}

function handleRunFailure( data, textStatus, jqXHR ){

}

function run_submit(){
    params_set();
    num_validation_errors = params_validate();   
    var session_id = getSessionId(); 
    var dataset = JSON.stringify({'session_id':session_id});
    if(num_validation_errors == 0){
        $.ajax(
            { url: API+"run/submit",
            method: 'post',
            dataType: 'json',
            contentType: "application/json",
            data:  dataset,
            success: startMonitor,
            fail: handleRunFailure 
            });
    }
}

$(document).ready(function(){
    params_get("get");
});

</script>
</html>